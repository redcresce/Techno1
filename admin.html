<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - تكنو تل</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Cairo',sans-serif;background:#f7f9fc;padding:18px}
  .card{border-radius:12px}
  .img-thumb{width:64px;height:48px;object-fit:cover;border-radius:6px}
  .muted{color:#6c757d}
  .btn-small{padding:.35rem .6rem;font-size:.85rem}
</style>
</head>
<body>
<div class="container">
  <div class="card p-4">
    <h3>لوحة إدارة — تكنو تل</h3>
    <p class="muted">الصق توكن GitHub هنا **محلياً فقط**. لا تشاركه مع أي أحد.</p>

    <!-- Login -->
    <div id="loginBox">
      <div class="row g-2">
        <div class="col-md-6"><input id="pwd" type="password" class="form-control" placeholder="كلمة المرور"></div>
        <div class="col-md-3"><button class="btn btn-primary w-100" onclick="login()">دخول</button></div>
        <div class="col-md-3"><button class="btn btn-outline-secondary w-100" onclick="showTokenHelp()">مساعدة التوكن</button></div>
      </div>
    </div>

    <!-- Admin UI -->
    <div id="adminUI" style="display:none;margin-top:20px">

      <!-- Token -->
      <div class="mb-3 row align-items-center">
        <div class="col-md-7">
          <input id="ghToken" class="form-control" placeholder="الصق GitHub Token هنا">
        </div>
        <div class="col-md-2"><button class="btn btn-success w-100" onclick="saveToken()">حفظ التوكن</button></div>
        <div class="col-md-3"><button class="btn btn-danger w-100" onclick="clearToken()">حذف التوكن</button></div>
      </div>

      <div class="mb-2">حالة المزامنة: <span id="syncStatus" style="color:gray">غير متصل</span></div>

      <!-- Categories management -->
      <div class="card p-3 mb-3">
        <h5>الأقسام</h5>
        <div class="row g-2 align-items-center mb-2">
          <div class="col-md-6"><input id="newCategory" class="form-control" placeholder="اسم القسم بالإنجليزية (id)"></div>
          <div class="col-md-3"><input id="newCategoryLabel" class="form-control" placeholder="التسمية العربية"></div>
          <div class="col-md-3"><button class="btn btn-primary w-100" onclick="addCategory()">أضف قسم</button></div>
        </div>
        <div id="categoriesList" class="mb-1"></div>
      </div>

      <!-- Add product -->
      <div class="card p-3 mb-3">
        <h5>أضف منتج</h5>
        <div class="row g-2 align-items-center">
          <div class="col-md-3"><input id="pName" class="form-control" placeholder="اسم المنتج"></div>
          <div class="col-md-2"><input id="pPrice" class="form-control" placeholder="السعر"></div>
          <div class="col-md-4"><input id="pImage" class="form-control" placeholder="رابط الصورة (استخدم ibb.co)"></div>
          <div class="col-md-2">
            <select id="pCategory" class="form-control"></select>
          </div>
          <div class="col-md-1"><button class="btn btn-primary w-100" onclick="addProduct()">أضف</button></div>
        </div>
        <div class="mt-2">
          <input id="pSearch" class="form-control" placeholder="بحث في المنتجات..." oninput="renderList()">
        </div>
      </div>

      <!-- Products list -->
      <h5>قائمة المنتجات</h5>
      <div id="list"></div>

      <hr>
      <div class="d-flex gap-2 mb-2">
        <button class="btn btn-outline-secondary" onclick="manualSync()">مزامنة الآن</button>
        <button class="btn btn-outline-dark" onclick="downloadJSON()">تحميل JSON</button>
      </div>
    </div>
  </div>
</div>

<script>
const GITHUB_USER = 'redcresce';
const GITHUB_REPO = 'Techno1';
let ADMIN_PASSWORD = 't3chn0tel';
let categories = [];
let products = {};
const tokenKey = 'techno_admin_token_v1';
let token = localStorage.getItem(tokenKey) || '';

const syncStatus = document.getElementById('syncStatus');
const categoriesList = document.getElementById('categoriesList');
const pCategorySelect = document.getElementById('pCategory');
const ghTokenInput = document.getElementById('ghToken');
const listDiv = document.getElementById('list');

function setStatus(msg, ok=true){
  syncStatus.textContent = msg;
  syncStatus.style.color = ok?'green':'red';
}

function showTokenHelp(){
  alert('اصنع GitHub Personal Access Token -> public_repo. الصقه هنا فقط في المتصفح.');
}

function login(){
  if(document.getElementById('pwd').value === ADMIN_PASSWORD){
    document.getElementById('loginBox').style.display='none';
    document.getElementById('adminUI').style.display='block';
    ghTokenInput.value = token || '';
    initAdmin();
  }else alert('كلمة المرور خاطئة');
}

function saveToken(){
  const t = ghTokenInput.value.trim();
  if(!t){ alert('أدخل التوكن أولاً'); return; }
  localStorage.setItem(tokenKey,t);
  token = t;
  setStatus('التوكن محفوظ محلياً');
  initAdmin();
}

function clearToken(){
  localStorage.removeItem(tokenKey);
  token = '';
  ghTokenInput.value='';
  setStatus('تم حذف التوكن',false);
}

/* ---------- Categories ---------- */
function renderCategories(){
  categoriesList.innerHTML='';
  pCategorySelect.innerHTML='';
  categories.forEach(c=>{
    const div=document.createElement('div');
    div.className='d-flex align-items-center justify-content-between mb-1';
    div.innerHTML=`<div><b>${c.label}</b> <small class="muted">(${c.id})</small></div>
      <div>
      <button class="btn btn-sm btn-warning btn-small me-1" onclick="renameCategory('${c.id}')">تعديل</button>
      <button class="btn btn-sm btn-danger btn-small" onclick="deleteCategory('${c.id}')">حذف</button>
      </div>`;
    categoriesList.appendChild(div);
    const opt=document.createElement('option');
    opt.value=c.id; opt.textContent=c.label;
    pCategorySelect.appendChild(opt);
  });
}

function addCategory(){
  const id=(document.getElementById('newCategory').value||'').trim();
  const label=(document.getElementById('newCategoryLabel').value||'').trim();
  if(!id||!label){ alert('ادخل id والقسم'); return; }
  if(categories.some(c=>c.id===id)){ alert('القسم موجود'); return; }
  categories.push({id,label});
  renderCategories();
  products[id]=[];
  saveCategoryJSON(id);
  document.getElementById('newCategory').value='';
  document.getElementById('newCategoryLabel').value='';
}

function renameCategory(id){
  const cat=categories.find(c=>c.id===id);
  const newLabel=prompt('التسمية العربية للقسم',cat.label);
  if(newLabel!==null){ cat.label=newLabel; renderCategories(); saveCategoryJSON(id); }
}

function deleteCategory(id){
  if(!confirm('حذف القسم؟')) return;
  categories=categories.filter(c=>c.id!==id);
  renderCategories();
  delete products[id];
  deleteCategoryJSON(id);
}

/* ---------- Products ---------- */
function renderList(){
  listDiv.innerHTML='';
  const q=(document.getElementById('pSearch').value||'').toLowerCase();
  Object.keys(products).forEach(cat=>{
    products[cat].forEach((p,i)=>{
      if(q && !p.name.toLowerCase().includes(q)) return;
      const div=document.createElement('div');
      div.className='card p-2 mb-2';
      div.innerHTML=`<div class="row align-items-center">
        <div class="col-2"><img src="${p.image}" class="img-thumb" /></div>
        <div class="col-6"><b>${p.name}</b><br><small class="text-muted">${p.price} • ${cat}</small></div>
        <div class="col-4 text-end">
          <button class="btn btn-sm btn-warning btn-small me-1" onclick="editProduct('${cat}',${i})">تعديل</button>
          <button class="btn btn-sm btn-danger btn-small" onclick="deleteProduct('${cat}',${i})">حذف</button>
        </div></div>`;
      listDiv.appendChild(div);
    });
  });
}

function addProduct(){
  const name=(document.getElementById('pName').value||'').trim();
  const price=(document.getElementById('pPrice').value||'').trim();
  const image=(document.getElementById('pImage').value||'').trim();
  const cat=(document.getElementById('pCategory').value||'').trim();
  if(!name||!image){ alert('الاسم والرابط مطلوب'); return; }
  if(!products[cat]) products[cat]=[];
  products[cat].push({name,price,image});
  renderList();
  saveProductJSON(cat);
  document.getElementById('pName').value='';
  document.getElementById('pPrice').value='';
  document.getElementById('pImage').value='';
}

function editProduct(cat,index){
  const p=products[cat][index];
  const n=prompt('اسم المنتج',p.name); if(n===null) return;
  const pr=prompt('السعر',p.price); if(pr===null) return;
  const im=prompt('رابط الصورة',p.image); if(im===null) return;
  products[cat][index]={name:n,price:pr,image:im};
  renderList();
  saveProductJSON(cat);
}

function deleteProduct(cat,index){
  if(!confirm('حذف المنتج؟')) return;
  products[cat].splice(index,1);
  renderList();
  saveProductJSON(cat);
}

/* ---------- GitHub JSON sync (products per category) ---------- */
async function saveProductJSON(cat){
  if(!token) return;
  const path=`${cat}.json`;
  const body=JSON.stringify(products[cat],null,2);
  const api=`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;
  try{
    const res=await fetch(api+'?_='+Date.now(),{headers:{Authorization:'token '+token}});
    let sha=null;
    if(res.ok){ const j=await res.json(); sha=j.sha; }
    const put=await fetch(api,{method:'PUT',headers:{Authorization:'token '+token,'Content-Type':'application/json'},body:JSON.stringify({message:`Update ${cat}.json`,content:btoa(unescape(encodeURIComponent(body))),sha})});
    if(!put.ok) console.error('GitHub PUT failed',await put.text());
  }catch(e){console.error(e);}
}

async function saveCategoryJSON(cat){
  if(!token) return;
  const path=`categories.json`;
  const body=JSON.stringify(categories,null,2);
  const api=`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;
  try{
    const res=await fetch(api+'?_='+Date.now(),{headers:{Authorization:'token '+token}});
    let sha=null; if(res.ok){const j=await res.json();sha=j.sha;}
    await fetch(api,{method:'PUT',headers:{Authorization:'token '+token,'Content-Type':'application/json'},body:JSON.stringify({message:`Update categories.json`,content:btoa(unescape(encodeURIComponent(body))),sha})});
  }catch(e){console.error(e);}
}

async function deleteCategoryJSON(cat){if(!token) return; const api=`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${cat}.json`; try{await fetch(api,{method:'DELETE',headers:{Authorization:'token '+token,'Content-Type':'application/json'},body:JSON.stringify({message:`Delete ${cat}.json`})});}catch(e){console.error(e);}}

/* ---------- Manual Sync ---------- */
function manualSync(){
  categories.forEach(c=>saveProductJSON(c.id));
  saveCategoryJSON();
  setStatus('تمت المزامنة يدوياً');
}

/* ---------- Init ---------- */
function initAdmin(){
  renderCategories();
  // Load products from GitHub (per category)
  categories.forEach(async c=>{
    if(!token) return;
    try{
      const res=await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${c.id}.json`,{headers:{Authorization:'token '+token}});
      if(res.ok){ const j=await res.json(); const content=atob(j.content.replace(/\n/g,'')); products[c.id]=JSON.parse(content); renderList(); }
      else products[c.id]=[];
    }catch(e){products[c.id]=[];}
  });
}

function downloadJSON(){
  const blob=new Blob([JSON.stringify(products,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='products_all.json';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
